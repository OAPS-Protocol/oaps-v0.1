<!DOCTYPE html>
<html>
<head>
    <title>OAPS v0.1 - Proof Signer & Registry</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 2rem auto; padding: 1rem; }
        input, textarea, button { display: block; width: 100%; margin: 0.5rem 0; padding: 0.5rem; box-sizing: border-box; }
        button { background: #000; color: #fff; border: none; cursor: pointer; }
        .success { color: green; font-weight: bold; }
        .error { color: red; }
        .section { border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; }
    </style>
</head>
<body>
    <h1>üîê OAPS v0.1 - Proof Signer & Registry</h1>
    <p>Connect your wallet, sign a proof hash, and register it on the OAPS Sepolia Registry.</p>

    <div class="section">
        <h3>1. Connect Wallet</h3>
        <button id="connectButton">ü¶ä Connect MetaMask</button>
        <p>Connected Account: <span id="accountAddress">Not connected</span></p>
    </div>

    <div class="section">
        <h3>2. Enter Proof Hash</h3>
        <p>Paste the keccak256 hash of your canonicalized OAPS proof JSON.</p>
        <input type="text" id="proofHashInput" placeholder="0x1234..." size="70">
        <button id="signButton">‚úçÔ∏è Sign Proof Hash</button>
        <p>Signature: <span id="signatureOutput">-</span></p>
    </div>

    <div class="section">
        <h3>3. Register on OAPS Registry (Sepolia)</h3>
        <p><strong>Contract:</strong> <code>0x83e7593D3c8343437d92094d9485D6eDBfF89131</code></p>
        <button id="registerButton">üìù Register Proof (Send Transaction)</button>
        <p id="transactionResult">-</p>
    </div>

    <div class="section">
        <h3>4. Verify Registration</h3>
        <button id="verifyButton">üîç Check Registration Time</button>
        <p>Result: <span id="verificationResult">-</span></p>
    </div>

    <script>
        let provider, signer, contract, userAddress;
        const contractAddress = "0x83e7593D3c8343437d92094d9485D6eDBfF89131";
        const contractABI = [
            "function registerProof(bytes32 _proofHash, bytes calldata _signature) external returns (bool)",
            "function registrationTime(bytes32 _proofHash) external view returns (uint256)"
        ];

        // 1. Connect Wallet
        document.getElementById('connectButton').onclick = async () => {
            if (typeof window.ethereum === 'undefined') {
                alert("Please install MetaMask!");
                return;
            }
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            document.getElementById('accountAddress').textContent = userAddress;
            contract = new ethers.Contract(contractAddress, contractABI, signer);
            console.log("Connected:", userAddress);
        };

        // 2. Sign Proof Hash
        document.getElementById('signButton').onclick = async () => {
            const proofHash = document.getElementById('proofHashInput').value.trim();
            if (!proofHash.startsWith('0x') || proofHash.length !== 66) {
                alert("Invalid hash. Must be 66 chars (0x + 64 hex).");
                return;
            }
            try {
                const signature = await signer.signMessage(ethers.utils.arrayify(proofHash));
                document.getElementById('signatureOutput').textContent = signature;
                console.log("Signature:", signature);
            } catch (err) {
                alert("Signing failed: " + err.message);
            }
        };

        // 3. Register Proof
        document.getElementById('registerButton').onclick = async () => {
            const proofHash = document.getElementById('proofHashInput').value.trim();
            const signature = document.getElementById('signatureOutput').textContent;
            if (signature === '-') {
                alert("Please sign the hash first.");
                return;
            }
            try {
                const tx = await contract.registerProof(proofHash, signature);
                document.getElementById('transactionResult').innerHTML = 
                    `<span class="success">‚úÖ Transaction sent: ${tx.hash}</span>`;
                await tx.wait();
                document.getElementById('transactionResult').innerHTML += 
                    `<br><span class="success">‚úîÔ∏è Confirmed!</span>`;
            } catch (err) {
                document.getElementById('transactionResult').innerHTML = 
                    `<span class="error">‚ùå Failed: ${err.message}</span>`;
            }
        };

        // 4. Verify Registration
        document.getElementById('verifyButton').onclick = async () => {
            const proofHash = document.getElementById('proofHashInput').value.trim();
            if (!proofHash.startsWith('0x')) {
                alert("Enter a valid proof hash.");
                return;
            }
            try {
                const timestamp = await contract.registrationTime(proofHash);
                if (timestamp.toString() === '0') {
                    document.getElementById('verificationResult').innerHTML = 
                        `<span class="error">‚ùå Not registered (timestamp: 0)</span>`;
                } else {
                    document.getElementById('verificationResult').innerHTML = 
                        `<span class="success">‚úÖ Registered at timestamp: ${timestamp.toString()}</span>`;
                }
            } catch (err) {
                document.getElementById('verificationResult').innerHTML = 
                    `<span class="error">‚ùå Error: ${err.message}</span>`;
            }
        };
    </script>

    <hr>
    <p><strong>Workflow:</strong> Connect ‚Üí Paste Proof Hash ‚Üí Sign ‚Üí Register ‚Üí Verify.</p>
    <p><strong>Note:</strong> This is a prototype. The proof hash must be generated separately using the OAPS canonicalization tool.</p>
</body>
</html>
