<!DOCTYPE html>
<html>
<head>
    <title>OAPS v0.1 - Proof Builder & Registry</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 2rem auto; padding: 1rem; }
        input, textarea, button, select { display: block; width: 100%; margin: 0.5rem 0; padding: 0.5rem; box-sizing: border-box; }
        button { background: #000; color: #fff; border: none; cursor: pointer; }
        button:disabled { background: #666; cursor: not-allowed; }
        button.small { width: auto; display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.9em; }
        .success { color: green; font-weight: bold; }
        .error { color: red; }
        .warning { color: orange; font-weight: bold; }
        .section { border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; }
        .status { font-family: monospace; word-break: break-all; padding: 0.5rem; background: #f5f5f5; }
        .network-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #8B5CF6;
            color: white;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .network-badge.sepolia { background: #8B5CF6; }
        .network-badge.other { background: #EF4444; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .info-box { padding: 1rem; background: #f0f9ff; border-left: 4px solid #3b82f6; margin: 1rem 0; }
    </style>
</head>
<body>
    <h1>üîê OAPS v0.1 - Proof Builder & Registry</h1>
    <p>Build a canonical audit proof, generate its hash, sign it, and register it on-chain.</p>
    <p class="warning">‚ö†Ô∏è This dApp requires <strong>Sepolia Testnet</strong> to prevent real ETH loss.</p>

    <!-- 1. Network & Wallet -->
    <div class="section">
        <h3>1. Network & Wallet</h3>
        <div id="networkStatus" class="status">Checking network...</div>
        <button id="connectButton" disabled>ü¶ä Connect MetaMask</button>
        <p>Connected Account: <span id="accountAddress" class="status">Not connected</span></p>
    </div>

    <!-- üÜï NEW: Proof Builder Section -->
    <div class="section">
        <h3>üîß 2. Build Your Proof</h3>
        <p>Fill in your audit details. The tool will create the canonical OAPS proof and compute its hash.</p>
        
        <label><strong>Audit ID (UUID v4):</strong></label>
        <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="auditId" placeholder="f47ac10b-58cc-4372-a567-0e02b2c3d479">
            <button class="small" onclick="generateUUID()" type="button">Generate UUID</button>
        </div>
        
        <label><strong>Project Name:</strong></label>
        <input type="text" id="projectName" placeholder="MyDeFiProtocol">
        
        <label><strong>Contract Address:</strong></label>
        <input type="text" id="projectAddress" placeholder="0x1234567890123456789012345678901234567890">
        
        <label><strong>Blockchain:</strong></label>
        <select id="blockchain">
            <option value="ethereum">Ethereum</option>
            <option value="arbitrum">Arbitrum</option>
            <option value="polygon">Polygon</option>
            <option value="base">Base</option>
            <option value="sepolia">Sepolia (Testnet)</option>
        </select>
        
        <label><strong>Auditor Ethereum Address (Your ID):</strong></label>
        <input type="text" id="auditorId" placeholder="0xabcdef1234567890abcdef1234567890abcdef12">
        
        <label><strong>Git Commit Hash (SHA-1, 40 chars):</strong></label>
        <input type="text" id="commitHash" placeholder="a1b2c3d4e5f6789012345678901234567890abcd">
        
        <label><strong>Audit Report SHA-256 Hash (64 chars):</strong></label>
        <input type="text" id="reportHash" placeholder="e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855">
        
        <p><strong>Findings Summary (Optional):</strong></p>
        <div class="form-grid">
            <input type="number" id="findingsCritical" placeholder="Critical" min="0" value="0">
            <input type="number" id="findingsHigh" placeholder="High" min="0" value="0">
            <input type="number" id="findingsMedium" placeholder="Medium" min="0" value="0">
            <input type="number" id="findingsLow" placeholder="Low" min="0" value="0">
        </div>
        
        <button id="buildProofButton" style="margin-top: 1rem;">üõ†Ô∏è Build Proof & Generate Hash</button>
        
        <div id="generatedOutput" style="display: none; margin-top: 1rem;">
            <div class="info-box">
                <h4>‚úÖ Proof Hash Generated!</h4>
                <p><strong>Your Proof Hash (ready to sign):</strong></p>
                <div class="status" id="generatedHash" style="color: green; font-size: 0.9em;"></div>
                <p><small>This hash has been auto-filled below. Continue to sign it with your wallet.</small></p>
            </div>
        </div>
    </div>

    <!-- 3. Sign Proof Hash (now auto-filled) -->
    <div class="section">
        <h3>3. Sign Proof Hash</h3>
        <p>Sign the generated hash with your wallet to create a cryptographic signature.</p>
        <input type="text" id="proofHashInput" placeholder="0x1234..." size="70" readonly>
        <button id="signButton" disabled>‚úçÔ∏è Sign Proof Hash</button>
        <p>Signature: <span id="signatureOutput" class="status">-</span></p>
    </div>

    <!-- 4. Register on OAPS Registry -->
    <div class="section">
        <h3>4. Register on OAPS Registry</h3>
        <p><strong>Contract:</strong> <code>0x83e7593D3c8343437d92094d9485D6eDBfF89131</code> <span class="network-badge sepolia">Sepolia</span></p>
        <button id="registerButton" disabled>üìù Register Proof (Send Transaction)</button>
        <p id="transactionResult">-</p>
    </div>

    <!-- 5. Verify Registration -->
    <div class="section">
        <h3>5. Verify Registration</h3>
        <button id="verifyButton" disabled>üîç Check Registration Time</button>
        <p>Result: <span id="verificationResult">-</span></p>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const SEPOLIA_CONFIG = {
            chainId: "0xaa36a7",
            chainName: "Sepolia",
            registry: "0x83e7593D3c8343437d92094d9485D6eDBfF89131",
            explorer: "https://sepolia.etherscan.io",
            rpcUrl: "https://rpc.sepolia.org"
        };
        
        // ‚úÖ CORRECT ABI (From Your Deployed Contract)
        const contractABI = [
            "function registerProof(bytes32 _proofHash, bytes memory _signature) external returns (bool)",
            "function registrationTime(bytes32 _proofHash) external view returns (uint256)",
            "function verifyProof(bytes32 _proofHash) external view returns (uint256)"
        ];

        // ==================== STATE ====================
        let provider = null;
        let signer = null;
        let contract = null;
        let userAddress = null;

        // üÜï PROOF BUILDER FUNCTIONS
        function generateUUID() {
            document.getElementById('auditId').value = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function sortObjectKeys(obj) {
            if (typeof obj !== 'object' || obj === null) return obj;
            if (Array.isArray(obj)) return obj.map(sortObjectKeys);
            const sorted = {};
            Object.keys(obj).sort().forEach(key => {
                sorted[key] = sortObjectKeys(obj[key]);
            });
            return sorted;
        }

        document.getElementById('buildProofButton').onclick = function() {
            console.log("üõ†Ô∏è Build Proof button clicked");
            
            try {
                // 1. Get all form values
                const auditId = document.getElementById('auditId').value.trim();
                const projectName = document.getElementById('projectName').value.trim();
                const projectAddress = document.getElementById('projectAddress').value.trim();
                const blockchain = document.getElementById('blockchain').value;
                const auditorId = document.getElementById('auditorId').value.trim();
                const commitHash = document.getElementById('commitHash').value.trim();
                const reportHash = document.getElementById('reportHash').value.trim();
                const findingsCritical = parseInt(document.getElementById('findingsCritical').value) || 0;
                const findingsHigh = parseInt(document.getElementById('findingsHigh').value) || 0;
                const findingsMedium = parseInt(document.getElementById('findingsMedium').value) || 0;
                const findingsLow = parseInt(document.getElementById('findingsLow').value) || 0;
                
                console.log("üìù Form values collected:", {
                    auditId, projectName, projectAddress, blockchain, 
                    auditorId, commitHash, reportHash
                });

                // 2. Basic validation
                if (!auditId) {
                    alert('‚ùå Audit ID is required');
                    return;
                }
                if (!auditId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i)) {
                    alert('‚ùå Please enter a valid UUID v4 for Audit ID');
                    return;
                }
                if (!projectAddress.startsWith('0x') || projectAddress.length !== 42) {
                    alert('‚ùå Please enter a valid 42-character Ethereum address (starting with 0x)');
                    return;
                }
                if (!commitHash.match(/^[a-f0-9]{40}$/i)) {
                    alert('‚ùå Commit hash must be 40-character SHA-1 hash');
                    return;
                }
                if (!reportHash.match(/^[a-f0-9]{64}$/i)) {
                    alert('‚ùå Report hash must be 64-character SHA-256 hash');
                    return;
                }

                // 3. Build proof object
                const proof = {
                    oapsVersion: "0.1.0",
                    auditId: auditId,
                    project: {
                        name: projectName,
                        address: projectAddress,
                        blockchain: blockchain
                    },
                    auditor: {
                        id: auditorId
                    },
                    auditScope: {
                        commitHash: commitHash,
                        files: []
                    },
                    reportHash: reportHash,
                    timestamp: new Date().toISOString().split('.')[0] + 'Z'
                };

                // Add optional findings
                if (findingsCritical > 0 || findingsHigh > 0 || findingsMedium > 0 || findingsLow > 0) {
                    proof.findingsSummary = { 
                        critical: findingsCritical, 
                        high: findingsHigh, 
                        medium: findingsMedium, 
                        low: findingsLow 
                    };
                }

                console.log("üì¶ Proof object built:", proof);

                // 4. Canonicalize and Hash (CORE OAPS LOGIC)
                console.log("üî¢ Starting canonicalization...");
                const sortedProof = sortObjectKeys(proof);
                const canonicalString = JSON.stringify(sortedProof, null, '');
                console.log("üìÑ Canonical string:", canonicalString);
                
                // Use ethers.js for keccak256 hashing
                const proofHash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(canonicalString));
                console.log("üîê Proof hash generated:", proofHash);

                // 5. Display and auto-fill
                document.getElementById('generatedHash').textContent = proofHash;
                document.getElementById('generatedOutput').style.display = 'block';
                document.getElementById('proofHashInput').value = proofHash;
                
                // Enable the sign button (user will connect wallet later)
                document.getElementById('signButton').disabled = false;
                
                // Scroll to show the result
                document.getElementById('generatedOutput').scrollIntoView({ behavior: 'smooth' });
                
                console.log("‚úÖ Proof hash successfully generated and displayed!");
                
            } catch (error) {
                console.error("‚ùå Error building proof:", error);
                alert("Error building proof: " + error.message);
            }
        };

        // ==================== WALLET & NETWORK ====================
        async function checkAndSwitchToSepolia() {
            const networkStatus = document.getElementById('networkStatus');
            if (typeof window.ethereum === 'undefined') {
                networkStatus.innerHTML = '<span class="error">‚ùå MetaMask not detected.</span>';
                return false;
            }
            try {
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (currentChainId === SEPOLIA_CONFIG.chainId) {
                    networkStatus.innerHTML = `<span class="success">‚úÖ Connected to Sepolia</span> <span class="network-badge sepolia">Sepolia</span>`;
                    document.getElementById('connectButton').disabled = false;
                    return true;
                }
                let networkName = "Unknown";
                switch(currentChainId) {
                    case "0x1": networkName = "Ethereum Mainnet"; break;
                    case "0xaa36a7": networkName = "Sepolia"; break;
                    default: networkName = `Chain ID: ${parseInt(currentChainId)}`;
                }
                networkStatus.innerHTML = `<span class="warning">‚ö†Ô∏è Current network: ${networkName}</span> <span class="network-badge other">Wrong Network</span>`;
                try {
                    networkStatus.innerHTML += `<br><span class="warning">‚è≥ Switching to Sepolia...</span>`;
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: SEPOLIA_CONFIG.chainId }],
                    });
                    networkStatus.innerHTML = `<span class="success">‚úÖ Switched to Sepolia</span> <span class="network-badge sepolia">Sepolia</span>`;
                    document.getElementById('connectButton').disabled = false;
                    return true;
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        networkStatus.innerHTML += `<br><span class="warning">‚è≥ Adding Sepolia network...</span>`;
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: SEPOLIA_CONFIG.chainId,
                                chainName: 'Sepolia Testnet',
                                nativeCurrency: { name: 'Sepolia ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: [SEPOLIA_CONFIG.rpcUrl],
                                blockExplorerUrls: [SEPOLIA_CONFIG.explorer]
                            }],
                        });
                        networkStatus.innerHTML = `<span class="success">‚úÖ Sepolia added and connected</span> <span class="network-badge sepolia">Sepolia</span>`;
                        document.getElementById('connectButton').disabled = false;
                        return true;
                    }
                    networkStatus.innerHTML = `<span class="error">‚ùå Please switch to Sepolia manually</span>`;
                    return false;
                }
            } catch (error) {
                networkStatus.innerHTML = `<span class="error">‚ùå Network error: ${error.message}</span>`;
                return false;
            }
        }

        // 1. Connect Wallet
        document.getElementById('connectButton').onclick = async () => {
            const networkOk = await checkAndSwitchToSepolia();
            if (!networkOk) return;
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                document.getElementById('accountAddress').textContent = userAddress;
                document.getElementById('accountAddress').style.color = "green";
                contract = new ethers.Contract(SEPOLIA_CONFIG.registry, contractABI, signer);
                console.log("‚úÖ Connected to Sepolia:", userAddress);
                document.getElementById('connectButton').disabled = true;
                document.getElementById('connectButton').textContent = "‚úÖ Connected";
                
                // Auto-fill auditor address if empty
                const auditorIdField = document.getElementById('auditorId');
                if (!auditorIdField.value) {
                    auditorIdField.value = userAddress;
                }
                
                // Network change listener
                window.ethereum.on('chainChanged', async (chainId) => {
                    console.log("Network changed to:", chainId);
                    if (chainId === SEPOLIA_CONFIG.chainId) {
                        location.reload();
                    } else {
                        document.getElementById('networkStatus').innerHTML = 
                            `<span class="error">‚ö†Ô∏è Switched away from Sepolia. Please switch back.</span>`;
                        document.getElementById('connectButton').disabled = true;
                    }
                });
            } catch (err) {
                console.error("Connection error:", err);
                alert("Connection failed: " + err.message);
            }
        };

        // 2. Sign Proof Hash
        document.getElementById('signButton').onclick = async () => {
            if (!signer) { 
                alert("Please connect wallet first!"); 
                return; 
            }
            const proofHash = document.getElementById('proofHashInput').value.trim();
            if (!proofHash.startsWith('0x') || proofHash.length !== 66) {
                alert("Invalid hash. Must be 66 chars (0x + 64 hex)."); 
                return;
            }
            try {
                const signature = await signer.signMessage(ethers.utils.arrayify(proofHash));
                document.getElementById('signatureOutput').textContent = signature;
                document.getElementById('signatureOutput').style.color = "blue";
                document.getElementById('registerButton').disabled = false;
                document.getElementById('signButton').disabled = true;
                document.getElementById('signButton').textContent = "‚úÖ Signed";
            } catch (err) { 
                alert("Signing failed: " + err.message); 
            }
        };

        // 3. Register Proof
        document.getElementById('registerButton').onclick = async () => {
            if (!contract) { 
                alert("Contract not initialized."); 
                return; 
            }
            const proofHash = document.getElementById('proofHashInput').value.trim();
            const signature = document.getElementById('signatureOutput').textContent;
            if (signature === '-') { 
                alert("Please sign the hash first."); 
                return; 
            }
            try {
                const tx = await contract.registerProof(proofHash, signature);
                document.getElementById('transactionResult').innerHTML = 
                    `<span class="success">‚úÖ Transaction sent: ${tx.hash}</span><br>
                     <a href="${SEPOLIA_CONFIG.explorer}/tx/${tx.hash}" target="_blank">View on Etherscan</a>`;
                const receipt = await tx.wait();
                document.getElementById('transactionResult').innerHTML += 
                    `<br><span class="success">‚úîÔ∏è Confirmed in block ${receipt.blockNumber}</span>`;
                document.getElementById('verifyButton').disabled = false;
                document.getElementById('registerButton').disabled = true;
                document.getElementById('registerButton').textContent = "‚úÖ Registered";
            } catch (err) {
                document.getElementById('transactionResult').innerHTML = 
                    `<span class="error">‚ùå Failed: ${err.message}</span>`;
            }
        };

        // 4. Verify Registration
        document.getElementById('verifyButton').onclick = async () => {
            if (!contract) { 
                alert("Contract not initialized."); 
                return; 
            }
            const proofHash = document.getElementById('proofHashInput').value.trim();
            if (!proofHash.startsWith('0x')) { 
                alert("Enter a valid proof hash."); 
                return; 
            }
            try {
                const timestamp = await contract.registrationTime(proofHash);
                if (timestamp.toString() === '0') {
                    document.getElementById('verificationResult').innerHTML = 
                        `<span class="error">‚ùå Proof not found in registry (timestamp: 0)</span>`;
                } else {
                    const dateStr = new Date(Number(timestamp) * 1000).toISOString();
                    document.getElementById('verificationResult').innerHTML = 
                        `<span class="success">‚úÖ Proof Registered!</span><br>
                         <strong>Registration Time:</strong> ${dateStr}`;
                    document.getElementById('verifyButton').disabled = true;
                    document.getElementById('verifyButton').textContent = "‚úÖ Verified";
                }
            } catch (err) {
                document.getElementById('verificationResult').innerHTML = 
                    `<span class="error">‚ùå Error: ${err.message}</span>`;
            }
        };

        // Initialize: Check network on page load
        window.addEventListener('load', async () => {
            await checkAndSwitchToSepolia();
        });
    </script>

    <hr>
    <p><strong>‚ö†Ô∏è Safety Notice:</strong> This dApp automatically enforces Sepolia Testnet to prevent accidental real ETH transactions.</p>
    <p><strong>Workflow:</strong> Build Proof ‚Üí Connect ‚Üí Sign ‚Üí Register ‚Üí Verify.</p>
    <p><strong>Network:</strong> Sepolia Testnet only | <strong>Contract:</strong> Verified on <a href="https://sepolia.etherscan.io/address/0x83e7593D3c8343437d92094d9485D6eDBfF89131" target="_blank">Etherscan</a></p>
    <p><strong>OAPS v0.1 Specification:</strong> <a href="SPECIFICATION.md" target="_blank">View</a></p>
</body>
</html>
